---
title: "Azure DevOps : Vos propres agents à la demande dans votre SI"
summary: "Une solution de bout en bout pour éxecuter des agents Azure DevOps conteneurisés dans votre réseau d'entreprise, ça vous dit ? Vous pourrez ainsi utilsier Azure DevOps Services pour gérer le déploiement de vos applications et services même dans les zones sécurisés de votre SI."
authors:
    - Philippe Morisseau
date: 2022-01-18
categorie: "Tips & Tricks"
image: img/cover/05.azuredevops.extension.agentless.png
tags:
    - DevOps
    - Azure DevOps
    - CI/CD
    - développement
    - Azure
    - Infra as Code
    - PaaS
---

Une solution de bout en bout pour éxecuter des agents **Azure DevOps** conteneurisés dans votre réseau d'entreprise, ça vous dit ? Vous pourrez ainsi utiliser **Azure DevOps Services** pour gérer le déploiement de vos applications et services même dans les zones sécurisés de votre SI. Dans mes précédents articles j'avais effleuré le sujet ([Azure DevOps : Créer sa propre task agentless](06.azuredevops.ephemeralagents.md) et [Azure Batch, le mal-aimé](../classroom/02.azureClassroom.batch.md)), dans cet article je vous propose de détailler comment mettre tout cela en place.

## Pourquoi le faire ?

- Si vous souhaitez utiliser **Azure DevOps Services** pour déployer vos applications et services dans votre SI d'entreprise qui est isolé d'un point de vue réseau.
- Si vous souhaitez utiliser des conteneurs pour vos opérations de **build** et/ou de déploiements afin d'éviter tout effet de bords liés aux précédentes executions de pieline **CI/CD**. 
- Si vous souhaitez réduire les temps de **build** et de déploiement de vos pipelines en pré-installant vos **frameworks** et outils **legacy** sur vos agents.

## L'architecture

Je vous propose d'orchestrer vos agents **Azure DevOps** avec **Azure Batch**. L'ensemble de l'architecture sera donc sur Azure. Bien entendu c'est une proposition, il est certain que vous pouvez réaliser une architecture équivante sur un autre hébergeurs **cloud** ou sur votre **cloud** privé.

![architecture](../../img/tips.06.schema-EphemeralAgents.svg)

Concrètement voici le séquencement qui va se produire pour la mise à disposition d'un agent éphémère :

1. Une tâche **agentless** "Invoke Azure Function" du pipeline de **build**/deploiement **Azure DevOps** appel la function **ProvideAzDOAgent** pour demander un agent éphémère,
2. Pour chaque appel, l'**Azure Function** crée une tâche dans **Azure Batch Account**,
3. L'**Azure Batch Account** traite les tâches et affecte la tâche au bon pool de nœuds,
4. Le pool de nœuds instancie un conteneur à partir de l'image présente dans l'**Azure Container Registry**,
5. Une fois le conteneur instancié et démarré, celui-ci s'enregistre auprès d'**Azure DevOps** pour faire savoir qu'il est disponible. **Azure DevOps** lui affecte alors un **job** en attente. 
6. Le **job Azure DevOps** s'exécute dans le **Virtual Network A** et peut communiquer avec le réseau **On Premise**.

On constate que le service **Azure Batch** (et ses **pools**) ainsi qu'**Azure Container Registry** sont complètement isolés d'un point de vue réseau. Sel l'**Azure function** est accessible publiquement. Cette dernière a cependant une règle firewall limitant les appels aux plages d'IP publiques d'**Azure DevOps Services**.

!!! note
    Microsoft met à disposition les plages d'**IP** du service **Azure DevOps** pour chacun des région : [ici](https://docs.microsoft.com/fr-fr/azure/devops/organizations/security/allow-list-ip-url?view=azure-devops&tabs=IP-V4#inbound-connections)

Il ne reste donc plus qua déployer notre infrastructure sur Azure.

## L'infrastructure

Vous trouverez ci-dessous le **template ARM** permettant de déployer rapidement l'infrastructure sur Azure.  

[![Deploy To Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FIneaweb%2Fazure.ephemeralagentrunner%2Fmain%2Farm%2Fazuredeploy.json)
[![Visualize](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/visualizebutton.svg?sanitize=true)](http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FIneaweb%2Fazure.ephemeralagentrunner%2Fmain%2Farm%2Fazuredeploy.json)

Cependant, il faut savoir qu'il y a quelques petites limitations :

1. Bien que vous puissiez déployer vos **pools Azure Batch** avec **ARM**, il n'est pas possible d'incrémenter l'infrastructure du **pool**. Autrement dit, vous ne pouvez pas modifier un **pool** existant. Et, c'est même pire puisque vous aurez une erreur si votre **pool** existe déjà au moment de l'execution de votre **template ARM**. Pour palier à cette limitation, j'ai ajouté 2 paramètres "create_WindowsBatchPool" et "create_UbuntuBatchPool".
2. Lors de la création de votre **container registry**, celui-ci ne contient aucune image. Il faudra ainsi prévoir l'importation des images de vos agents **Azure DevOps**. 

Pour cette seconde limitation, je vous propose d'étudier la conteneurisation de notre agent **Azure DevOps**. 

## Conteneuriser votre agent Azure DevOps

En parcourant [dockerhub](https://hub.docker.com/) à la recherche d'une image docker de mon agent **Azure DevOps**, j'ai découvert le projet de [Czon](https://github.com/codez-one/docker-azure-pipelines-agent).

Son projet consiste à automatiser la construction d'image docker afin d'embarquer systématiquement la dernière version de l'agent **Azure DevOps**. Ainsi, sur son **repository** [dockerhub](https://hub.docker.com/r/czon/azdo-agent) **Czon** partage les images ubuntu avec la dernière version de l'agent **Azure DevOps**. Ca c'est classe !

Je me suis donc permis de **forker** son repository **Github** pour apporter quelques petites évolution au travail déjà excellent de **Czon** pour ajouter les fonctionnalitées suivantes :

- Création de conteneurs sur les bases **Windows ltsc2019**, **Ubuntu 18.04** et **Ubuntu 20.04**,
- Pour chacun de ces **OS**, ajout des **frameworks dotnet core 3.1** et **dotnet 6.0**

Vous pouvez trouver mes modification sur mon repository [Github](https://github.com/Ineaweb/docker-azure-pipelines-agent), et les images générés sur [dockerhub](https://hub.docker.com/repository/docker/pmorisseau/azdo-agent).

Il ne reste plus qu'à importer les images de **dockerhub** vers votre **Azure Container Registry** avec les commandes **Azure CLI** suivantes :

```shell
    az acr import -n [YOUR_ACR_NAME] --source docker.io/pmorisseau/azdo-agent:ubuntu-20.04-azdo -t azdo-agent:ubuntu-20.04-azdo
    az acr import -n [YOUR_ACR_NAME] --source docker.io/pmorisseau/azdo-agent:ubuntu-20.04-azdo -t azdo-agent:ubuntu-18.04-azdo
    az acr import -n [YOUR_ACR_NAME] --source docker.io/pmorisseau/azdo-agent:windows-core-ltsc2019-azdo -t azdo-agent:windows-core-ltsc2019-azdo
```

