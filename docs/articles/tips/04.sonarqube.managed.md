---
title: "Déployer Sonarqube sur des services managés Azure."
summary: "Sonarqube propose des images docker disponible sur le docker hub. En même temps les Azure WebApp permettent d'executer des conteneurs docker. Pourquoi ne pas faire tourner Sonarqube sur une Azure WebApp ?"
authors:
    - Philippe Morisseau
date: 2021-09-27
---

Dans le cadre de plusieurs clients pour qui j'ai eu l'occasion de travailler j'ai eu besoin de déployer l'outil Sonarqube. Sonarqube propose des images docker disponible sur le docker hub. En même temps les **Azure WebApp** permettent d'executer des conteneurs docker. Pourquoi ne pas faire tourner Sonarqube sur une **Azure WebApp** ?
On simplifera ainsi grandement la maintenance de ce service.

### L'architecture

Il existe déjà sur le github de microsoft un quickstart template ARM qui permet de déployer Sonarqube sur une **Azure WebApp** avec une base de données **Azure SQL database**.
Le souci de ce quickstart c'est :
- qu'il ne permet pas de déployer la dernière version de Sonarqube (8.9 LTS),
- qu'il n'isole pas au niveau réseau.
- qu'il ne permet pas de conserver les plugins de sonarqube en cas d'incident sur l'**Azure WebApp**.

Je vous porpose donc de revoir un peu l'architecture afin de blinder tout cela :
![archi](../../img/sonarqube.managed.svg)

- On va ajouter un **Storage Account** qui contiendra les extensions et les données de sonarqube afin de garantir la résilience de la solution. En cas de dysfonctionnement de l'**Azure WebApp** qui pourrait entrainer un changement d'instance du service plan, les données sonarqube ne seront pas perdu. Et même s'il on doit migrer la solution sur un autre cloud provider par exemple, nous seront en capaciter de faire cette migration sereinement.

- Ensuite, on va créer un **Virtual network** et un **Subnet** dans lequel on va intégrer notre **Azure WebApp**. On va ajouter des services endpoints du **Storage Account** et du **Sql Server** à notre **Subnet**. Ainsi notre **Azure WebApp** pourra communiquer avec les autres services managés sans risque de passer sur internet.

- Enfin, on va mettre en place des règles firewall pour empècher qu'un utilisateur en dehors de notre **Virtual Network** puisse accéder aux informations de sonarqube. 
  - on va restreindre le **Storage Account** au **Subnet** de notre **Azure WebApp**.
  - on va faire de même pour l'**Azure Sql Server**.
  - on va restreindre l'**Azure WebApp** aux autre **Subnet** de notre **Virtual Network**.

### Résultat



Vous trouverez ci-dessous les templates ARM permettant de déployer rapidement un Sonarqube isolé au niveau réseau.  

[![Deploy To Azure](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/deploytoazure.svg?sanitize=true)](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FIneaweb%2FBlog%2Fmain%2Fassets%2Farm.sonarqube%2Fazuredeploy.json)
[![Visualize](https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/1-CONTRIBUTION-GUIDE/images/visualizebutton.svg?sanitize=true)](http://armviz.io/#/?load=https%3A%2F%2Fraw.githubusercontent.com%2FIneaweb%2FBlog%2Fmain%2Fassets%2Farm.sonarqube%2Fazuredeploy.json)

### Références

- [Deploy Sonarqube on a Linux web app with Azure SQL](https://github.com/Azure/azure-quickstart-templates/tree/master/quickstarts/microsoft.web/webapp-linux-sonarqube-azuresql)
- [Sonarqube on Docker Hub](https://hub.docker.com/_/sonarqube)

### Remerciement

- [Quentin Joseph](https://www.linkedin.com/in/quentin-joseph-a4962b87/) : pour la relecture
- [Laurent Mondeil](https://www.linkedin.com/in/laurent-mondeil-0a87a743/) : pour la relecture

_Rédigé par Philippe MORISSEAU, Publié le 27 Septembre 2021_