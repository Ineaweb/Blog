---
title: "Adopter une démarche GitOps grâce à Azure App Configuration (Partie 2)"
summary: "Dans mon dernier talk \"GitOps, Continuous Delivery et les environnements : comment éviter l'enfer !\", un participant m'a fait remarquer qu'il serait bien de montrer concrètement comment mettre en place une démarche GitOps avec des outils modernes.
Etant un adepte des services managés d'Azure, je vous propose donc d'étudier comment mettre en place une démarche GitOps avec Azure App Configuration."
authors:
    - Philippe Morisseau
date: 2022-04-25
categorie: "Adopter une démarche GitOps"
image: img/cover/09.gitops.png
tags:
    - DevOps
    - GitOps
    - CI/CD
    - développement
    - Azure
    - PaaS
---


Nos configurations seront certainement différentes en fonction de nos environnements. 
Comment gérer ces configurations distincts ?
La modification de la configuration de l'environnement de recette n'a pas à impacter la configuration de l'environnement d'intégration ou de production. Cela veut-il dire que je dois mettre cela dans des fichiers distincts ? dans des **repos** distincts ? ou même ailleurs ?

### Gérer votre configuration par environnement

Il n'y a pas une seul et unique réponse. Posez-vous quelques questions.

 - Est-ce que vous avez besoin d'avoir un historique de la configuration spécifique à chacun de vos environnements ?
 - Combien de paramètres d'environnement (en dehors des paramètres sensibles) vous allez devoir gérer ?
 - Quel est la fréquence de vos mises à jour d'environnement ?

Si vous avez de nombreux paramètres d'environnement, l'utilisation d'un fichier de configuration par environnement dans votre **repo. git** est peut-être la solution.

Si vous prévoyez de modifier votre configuration d'environnement régulièrement, peut-être que des **repos** par environnement peut-être une bonne solution.

Cela va vraiement dépendre de votre situation. Je vais quand même vous proposer de décrire quelques solutions qui peuvent être mises en place avec **Azure DevOps**.

#### Gérer votre configuration d'environnement avec les library Azure DevOps.

Si vous n'avez pas besoin de l'historique de vos configurations d'environnement, les **Library Azure DevOps** sont peut-être suffisantes.
Utilisé conjointement dans votre pipeline **CD** avec une tâche du type *replacetokens*, vous pourrez alors surcharger votre configuration commune par les spécificités de vos environnements.

Par exemple, si vous définissez dans une libraire **Azure DevOps** les paramètres :

- NB_NODES : Nombre de noeuds de votre cluster,
- ALLOW_ANONYMOUS_ACCESS : Top indiquant si la webApp est accessible sans authentification,
- SUPER_ADMIN_USER : Identité du super administrateur du cluster. 

En utilisant, la tâche *replacetokens*, vous aurez un fichier de configuration dans votre **repo git** de ce type :

  ```yaml
  TestApp:Settings:Param1: ValueOfParam1
  TestApp:Settings:Param2: ValueOfParam2
  All:Settings:Param3: ValueOfParam3
  Cluster:Settings:NbNodes: #{NB_NODES}#
  WebApp:Settings:AllowAnonymousAccess: #{ALLOW_ANONYMOUS_ACCESS}#
  Cluster:Settings:SuperAdmin: #{SUPER_ADMIN_USER}#
  ```

L'incovénient c'est que vous aurez un autre référentiel de configuration à gérer. Ce n'est pas l'idéal en terme de maintenabilité.

#### Gérer votre configuration d'environnement dans des fichiers distincts.

Dans ce cas, si vous avez de nombreux paramètres d'environnement, l'utilisation d'un fichier de configuration par environnement dans votre **repo. git** est peut-être la solution.

Par exemple, pour les paramètres :

- NB_NODES : Nombre de noeuds de votre cluster,
- ALLOW_ANONYMOUS_ACCESS : Top indiquant si la webApp est accessible sans authentification,
- SUPER_ADMIN_USER : Identité du super administrateur du cluster. 

Vous aurez :

- un fichier *config.yml* contenant les paramètres de configuration commun contenant :
    ```yaml
    TestApp:Settings:Param1: ValueOfParam1
    TestApp:Settings:Param2: ValueOfParam2
    All:Settings:Param3: ValueOfParam3
    Cluster:Settings:NbNodes: 2
    WebApp:Settings:AllowAnonymousAccess: true
    Cluster:Settings:SuperAdmin:
    ```
- un fichier *config.dev.yml* contenant les paramètres de configuration spécifique à l'environnement de *DEV*,
    ```yaml
    Cluster:Settings:SuperAdmin: admin_dev@test.fr
    ``` 
- un fichier *config.uat.yml* contenant les paramètres de configuration spécifique à l'environnement de *UAT*, 
    ```yaml
    WebApp:Settings:AllowAnonymousAccess: false
    Cluster:Settings:SuperAdmin: admin_uat@test.fr
    ``` 
- un fichier *config.prd.yml* contenant les paramètres de configuration spécifique à l'environnement de *PROD*.
    ```yaml
    Cluster:Settings:NbNodes: 5
    WebApp:Settings:AllowAnonymousAccess: false
    Cluster:Settings:SuperAdmin: admin_prd@test.fr
    ``` 